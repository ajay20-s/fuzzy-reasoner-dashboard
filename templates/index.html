<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Fuzzy Reasoner Visualization Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
      :root {
        --bg: #0d0f14;
        --panel: #191d26;
        --accent: #5daeff;
        --muted: #9ca3af;
        --text: #e5e7eb;
        --highlight: #2f80ed;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        display: grid;
        grid-template-columns: 1fr 350px;
        height: 100vh;
        overflow: hidden;
      }

      #graph {
        width: 100%;
        height: 100%;
        cursor: grab;
      }

      #sidebar {
        background: var(--panel);
        padding: 20px;
        overflow-y: auto;
        border-left: 1px solid #2a2f3a;
      }

      h1 {
        margin-top: 0;
        color: var(--accent);
        text-align: center;
      }

      .panel {
        background: #1d222f;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 18px;
      }

      input,
      .slider {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        background: #232833;
        border-radius: 5px;
        border: 1px solid #333;
        color: var(--text);
      }

      .result {
        background: #222836;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
      }

      .degree-bar {
        background: var(--highlight);
        height: 6px;
        border-radius: 3px;
        margin-top: 5px;
      }

      .tooltip {
        position: absolute;
        background: rgba(30, 30, 40, 0.95);
        color: #fff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <svg id="graph"></svg>

    <div id="sidebar">
      <h1>Fuzzy Reasoner</h1>

      <div class="panel">
        <h3>üîç Search Sort</h3>
        <input id="search" placeholder="Search node..." />

        <h3>üéö Similarity Threshold</h3>
        <label>
          <span id="thval">0.0</span>
        </label>
        <input
          type="range"
          id="threshold"
          min="0"
          max="1"
          step="0.05"
          value="0"
          class="slider"
        />
      </div>

      <div class="panel">
        <h3>üìò Selected Sort</h3>
        <div id="selected">None</div>
      </div>

      <div class="panel">
        <h3>üß† Query Results</h3>
        <div id="results">Click a node to run query.</div>
      </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
      const svg = d3.select("#graph");
      const g = svg.append("g");
      const tooltip = d3.select("#tooltip");

      const width = window.innerWidth - 350;
      const height = window.innerHeight;

      const slider = document.getElementById("threshold");

      // Zoom
      const zoom = d3
        .zoom()
        .scaleExtent([0.4, 3])
        .on("zoom", (event) => g.attr("transform", event.transform));

      svg.call(zoom);

      // -----------------------------
      // Load & Draw Graph
      // -----------------------------
      function loadGraph() {
        const th = parseFloat(slider.value);

        fetch(`/graph?t=${th}`)
          .then((r) => r.json())
          .then((data) => {
            drawGraph(data);
          });
      }

      loadGraph();

      function drawGraph(data) {
        g.selectAll("*").remove();

        const nodes = data.nodes;
        const links = data.links;

        const simulation = d3
          .forceSimulation(nodes)
          .force(
            "link",
            d3
              .forceLink(links)
              .id((d) => d.id)
              .distance(200) // spacing improved
          )
          .force("charge", d3.forceManyBody().strength(-700))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collision", d3.forceCollide().radius(45));

        // Links
        const link = g
          .append("g")
          .selectAll("line")
          .data(links)
          .join("line")
          .attr("stroke", "#5daeff")
          .attr("stroke-opacity", 0.8)
          .attr("stroke-width", (d) => 2 + d.value * 4);

        // Nodes
        const nodeGroup = g
          .append("g")
          .selectAll("g")
          .data(nodes)
          .join("g")
          .attr("cursor", "pointer")
          .on("click", (_, d) => runQuery(d));

        nodeGroup
          .append("circle")
          .attr("r", 26)
          .attr("fill", "#16202f")
          .attr("stroke", "#88b4ff")
          .attr("stroke-width", 1.7);

        nodeGroup
          .append("text")
          .text((d) => d.id)
          .attr("text-anchor", "middle")
          .attr("dy", 5)
          .attr("fill", "white")
          .attr("font-size", "13px");

        // Node search highlight
        document.getElementById("search").oninput = (e) => {
          const t = e.target.value.toLowerCase();

          nodeGroup
            .selectAll("circle")
            .attr("fill", (d) =>
              d.id.toLowerCase().includes(t) ? "#2f80ed" : "#16202f"
            );
        };

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          nodeGroup.attr("transform", (d) => `translate(${d.x},${d.y})`);
        });
      }

      // -----------------------------
      // Run QUERY on Node Click
      // -----------------------------
      function runQuery(d) {
        document.getElementById("selected").textContent = d.id;
        document.getElementById("results").innerHTML = "<i>Loading...</i>";

        fetch("/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sort: d.id,
            threshold: parseFloat(slider.value),
          }),
        })
          .then((r) => r.json())
          .then((results) => {
            const area = document.getElementById("results");
            area.innerHTML = "";

            if (results.length === 0) {
              area.innerHTML = "<i>No matching instances found.</i>";
              return;
            }

            results.forEach((r) => {
              const el = document.createElement("div");
              el.className = "result";

              el.innerHTML = `
              <b>${r.name}</b><br>
              <small>${r.unifier}</small>
              <div class="degree-bar" style="width:${r.degree * 100}%"></div>
            `;

              area.appendChild(el);
            });
          });
      }

      // -----------------------------
      // THRESHOLD Changed ‚Üí Reload Graph
      // -----------------------------
      slider.addEventListener("input", () => {
        document.getElementById("thval").textContent = slider.value;
        loadGraph();
      });
    </script>
  </body>
</html>
